# HTML Smuggling Leads to Domain Wide Ransomware

Авторы: 


Ссылка на контент: 
https://thedfirreport.com/2023/08/28/html-smuggling-leads-to-domain-wide-ransomware/

Краткое содержание: 

<blockquote>
We’ve previously reported on a Nokoyawa ransomware case in which the initial access was via an Excel macro and IcedID malware.   ...   <br>Within the password protected ZIP file, there was an ISO file that deployed IcedID which led to the use of Cobalt Strike and ultimately Nokoyawa ransomware.   ...   <br>When the malicious DLL was executed, persistence was also established via a scheduled task on the beachhead host.   ...   <br>Around three hours after execution of the initial IcedID malware, a cmd process was spawned from IcedID.   ...   <br>Using this session, the threat actor copied over a Cobalt Strike beacon to the domain controller and executed it.   ...   <br>After that, the threat actor continued discovery actions by executing a batch file on the domain controller, which ran the usual battery of Active Directory discovery commands using AdFind.   ...   <br>Five minutes after transferring the files to hosts in the domain, the Nokoyawa ransomware binary was executed on a domain controller.   ...   <br>At the same time, PsExec was used to execute the p.bat file starting the ransomware binary on the other hosts in the domain.   ...   <br>In this case we see two different threat actors; the distributor and the hands on keyboard actor.   ...   <br>This server name matches the one used by a threat actor from a prior Nokoyawa case.   ...   <br>The ISO file contained a LNK file, with an icon of an Image, which prompted the user to click on it.When the user opened the LNK file, the batch script demurest.cmd was executed.   ...   <br>Around six hours into the intrusion, 1.dll (Cobalt Strike) was dropped on the beachhead host before being copied to a domain controller.   ...   <br>After 1.dll was transferred to the domain controller, it was executed via rundll32.exe via following command:   ...   <br>On one of the domain controllers, an encoded PowerShell command was observed being executed from a Cobalt Strike beacon.   ...   <br>After loading IcedID DLL via the renamed rundll32, the following discovery commands were observed on the beachhead host:   ...   <br>As a part of discovery commands, IcedID used WMI to get the list of Anti-Virus product installed on the beachhead host with the following command:   ...   <br>The threat actor also ran the following discovery commands via cmd.exe (injected Beacon process):   ...   <br>AdFind was used for discovery on a domain controller via a batch script named adfind.bat.   ...   <br>The workstation name observed in a 4624 event on the beachhead:   ...   <br>And again in 4778 followed by 4779 on the domain controller:   ...   <br>Once k.exe and p.bat, and various other batch scripts were transferred to the compromised domain controller, the threat actor then tried to copy k.exe to other machines on the network via copy command executed on the domain controller.   ...   <br>After the injection into cmd.exe on the beachhead host, 1.dll (Cobalt Strike DLL) was created, which later was transferred to the domain controller.   ...   <br>Then, 1.dll was executed on the domain controller via rundll32.exe and after execution, rundll32.exe connected to the command and control server 5.8.18[.]242.   ...   <br>This server was observed in a prior case, which also resulted in Nokoyawa ransomware.   ...   
</blockquote>

Тэги: 


Дата публикования: 
2023-08-28T00:22:33+00:00

---

# Blindsiding auditd for Fun and Profit

Авторы: 


Ссылка на контент: 
https://code-white.com/blog/2023-08-blindsiding-auditd-for-fun-and-profit/

Краткое содержание: 

<blockquote>
The following example shows the attempt of a regular user to read the contents of the /etc/shadow file:   ...   <br>As with every detection and monitoring solution, there is no correct usage of auditd.   ...   <br>Tampering with events from a regular user context is therefore not that promising.   ...   <br>From a high privileged context however, it is possible to tamper with the userspace component of the audit system, which is the auditd daemon.   ...   <br>Uses /proc/PID/mem and /proc/PID/maps to tamper with the integrity of the auditd process Searches for an unused executable memory region within the auditd process to house shellcode (code cave) Injects event filtering shellcode into the code cave within the auditd process Replaces the recvfrom entry in the global offset table of auditd with a pointer to the shellcode daphne - Technical Details   ...   <br>ptrace is a well known system call that allows one process to monitor and control the execution of another process.   ...   <br>As already mentioned, auditd uses the recvfrom system call to obtain events from the kernel via netlink.   ...   <br>for (;;)   ...   <br>To tamper with auditd events, it is required to understand the format in which these events are emitted by the kernel.   ...   <br>The following listing shows some examples for raw event messages that are obtained by auditd from the netlink:   ...   <br>Two prominent examples include AUDIT_EXECVE with a numerical value of 1309 (0x51d), that is used for logging execve syscall events and AUDIT_EOE with a numerical value of 1320 (0x528), which is used to end a multi record event.   ...   <br>However, if the filtering rule does not apply to the first message within an event group, these events are still forwarded until the matching event message is reached.   ...   <br>Therefore, the filter pattern should preferably be one of the first messages within an auditd event group.   ...   <br>427 is the process ID of auditd, whereas 1476 is the process ID of a bash shell we want to exclude from monitoring:   ...   <br>The following events can be observed within the auditd log:   ...   <br>In the following example, the string /etc/shadow is replaced with /etc/no_shadow within every audit event:   ...   <br>By replacing the function pointer to recvfrom within the GOT of libaudit.so with a pointer to an event filtering version of recvfrom, auditd can be blindsided again.   ...   <br>Obviously, a function that behaves similar to recvfrom, but filters certain events cannot be found within the address space of the auditd process.   ...   <br>Instead, it is required to write some event filtering shellcode, inject it into the auditd process and replace the recvfrom pointer within the GOT of libaudit.so with a pointer to it.   ...   <br>The following assembly demonstrates a simple variant, where all events are filtered by returning a length of zero as the result of the recvfrom call:   ...   <br>ssize_t hook_func(int sockfd, char* buf, size_t len, int flags, struct sockaddr* src_addr, socklen_t* addrlen)   ...   <br>Use /proc/pid/maps to find the data segment of libaudit.so within the auditd process Use /proc/pid/maps to find the text segment of libc.so within the auditd process Determine the offset of recvfrom in libc.so and calculate its position within the auditd process Search the data segment of libaudit.so for a reference to recvfrom Find a code cave within the auditd process that is large enough to house the event filtering shellcode Write the event filtering shellcode to the code cave Replace the recvfrom reference within the GOT of libaudit.so with the code cave address   ...   <br>427 is the process ID of auditd, whereas 1059 is the process ID of a bash shell that we want to exclude from monitoring:   ...   <br>After patching auditd, we accessed the /etc/shadow file, first from a shell with process ID 1022, then within our evaded shell with process ID 1059 and afterwards again with PID 1022.   ...   <br>Permission to access this file is governed by a ptrace access mode PTRACE_MODE_ATTACH_FSCREDS check; see ptrace(2).   ...   <br>In fact, ptrace is not the only operation that requires ptrace access mode permissions.   ...   <br>[-] Function 'recvfrom' was not found in GOT of 1547.   ...   <br>apollon failed to find the recvfrom pointer within the GOT of libaudit.so, as reading auditd process memory via /proc/pid/mem was not possible.   ...   <br>Some of the detection mechanisms for daphne mentioned above can be used for detecting apollon.   ...   
</blockquote>

Тэги: 


Дата публикования: 
2023-08-03T00:00:00

---

