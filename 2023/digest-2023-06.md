# A Truly Graceful Wipe Out

Авторы: 


Ссылка на контент: 
https://thedfirreport.com/2023/06/12/a-truly-graceful-wipe-out/

Краткое содержание: 

<blockquote>
In this intrusion, dated May 2023, we observed Truebot being used to deploy Cobalt Strike and FlawedGrace (aka GraceWire & BARBWIRE) resulting in the exfiltration of data and the deployment of the MBR Killer wiper.   ...   <br>From there, FlawedGrace’s execution routine involved storing as well as extracting, encoded and encrypted payloads in registry; the creation of temporary scheduled tasks and the injection of the final payload into msiexec.exe and svchost.exe.   ...   <br>Approximately two hours after the initial execution, Truebot loaded Cobalt Strike into memory and then went dormant for the next two hours.   ...   <br>This ended the use of Truebot for the rest of the intrusion, with FlawedGrace and Cobalt Strike being leveraged for the rest of the threat actors activity.   ...   <br>Now, four hours into the intrusion the threat actors, through the Cobalt Strike beacon, started another round of discovery commands using net, nltest, tasklist and AdFind.exe.   ...   <br>The threat actors used Impacket’s atexec to execute discovery commands on remote hosts.   ...   <br>After these discovery commands, the threat actors used Cobalt Strike’s jump psexec module to further move between hosts.   ...   <br>Roughly four hours after the exfiltration began, merely 29 hours into the intrusion, the threat actors deployed the MBR Killer wiper on all hosts where FlawedGrace had been running, including a file server.   ...   <br>The MBR Killer binary in this case was attributed to the Lace Tempest activity group per Microsoft.   ...   <br>]18:443, which we observed in this case.   ...   <br>]199:443, which was also observed during this case.   ...   <br>]78, the Cobalt Strike server in this case.   ...   <br>Truebot was used to load both Cobalt Strike and FlawedGrace on the initial host.   ...   <br>Truebot spawned an instance of C:\Windows\system32\cmd.exe which was followed-up by a remote thread created in the new process.   ...   <br>In this case, the shell argument is a beacon command to spawn a new process.   ...   <br>The first observed behavior of this chain was to create a new instance of spoolsv.exe that was shortly accessed by the Truebot process (RuntimeBroker.exe).   ...   <br>The second was observed within obfuscated PowerShell, where the Schedule.Service COM Object was used to create a new task.   ...   <br>This account was added and removed several times, but after the first three hours of access, it was deleted and not re-added by the threat actors.   ...   <br>Scheduled tasks were used by the threat actors to run much of their malware as SYSTEM.   ...   <br>The initial execution tasks for FlawedGrace used the \2 registered task were created to run under SYSTEM as seen by the Author in the task details.   ...   <br>First, Truebot used it to inject the Cobalt Strike payload into a cmd.exe process.   ...   <br>File removal was observed with AdFind.exe being removed by the threat actors as well as Cobalt Strike beacon removal, after being used for lateral movement.   ...   <br>The logs of the credential access activity resemble those of secretsdump, which is a tool that is part of the Impacket library.   ...   <br>We noticed the creation of two temporary files in the C:\Windows\System32\ directory.   ...   <br>However, as with this case, we observed the temp files under C:\Windows\System32, which indicates the use of an older version of impacket.   ...   <br>C:\Windows\system32\cmd.exe /C for /f %i in (C:\ProgramData\servers_live.txt) do net view \\%i /all >> C:\ProgramData\servers_live_netview.txt   ...   <br>C:\Windows\system32\cmd.exe /C for /f %%i in (C:\ProgramData\servers_live.txt) do dir \\%%i\C$ >> C:\ProgramData\servers_live_dir.txt   ...   <br>We believe the execution of this command came through atexec.py, which is part of the impacket collection.   ...   <br>As we mentioned in the discovery phase, threat actors also used atexec to execute commands on remote hosts.   ...   <br>Threat actors used Cobalt Strike to facilitate the execution of this module.   ...   <br>process: represents the WMI class to be queried; in this case, it’s related to running processes on the target system.   ...   <br>We’ve created a chart displaying the times (UTC) when threat actors were active in the network.   ...   <br>As a reminder, the following discovery commands redirected their results to C:\ProgramData\hosts_live.txt and C:\ProgramData\servers_live.txt.   ...   <br>Command and Control Truebot   ...   <br>This connection, however, only lasted for around two hours on the beachhead host, and activity ceased after the Cobalt Strike beacon payload was loaded on the host.   ...   <br>Looking at memory collected from the beachhead host, we can observe the connection to the Truebot command and control server made by Runtimebroker.exe, the renamed executable copied from the initial malware payload.   ...   <br>During the first day of the intrusion, we observed a network signature hit for RDP tunneling from one of the FlawedGrace command and control servers, but due to no follow-up activity, it would appear that this did not function properly for the threat actors.   ...   <br>Cobalt Strike, unlike the other two malware families observed, remained in constant communication with its command and control server after the first beacon was loaded until the end of the intrusion.   ...   <br>While the Cobalt Strike command and control stayed active over the intrusion the threat actors did selectively deploy and remove it on hosts with only the beachhead host maintaining beaconing activity for the whole duration.   ...   <br>On the second day of the intrusion, a connection from a file server began to the IP 139.60.160[.   ...   <br>During this destructive stage, the threat actors named the file C:\ProgramData\chrome.exe on the beachhead, while on other servers the C:\Windows\Temp\[0-9a-f]{32}.exe naming pattern was used.   ...   <br>MBR Killer then proceeds to wipe the MBR (Master Boot Record) three times by writing 512 empty bytes at offset 0 and attempts to repeat the wiping on the next available disk (\\.\PHYSICALDRIVE1, \\.\PHYSICALDRIVE2, …).   ...   
</blockquote>

Тэги: 


Дата публикования: 
2023-06-12T01:06:26+00:00

---

