# SEO Poisoning to Domain Control: The Gootloader Saga Continues

Авторы: 


Ссылка на контент: 
https://thedfirreport.com/2024/02/26/seo-poisoning-to-domain-control-the-gootloader-saga-continues/

Краткое содержание: 

<blockquote>
Key Takeaways In February 2023, we detected an intrusion that was initiated by a user downloading and executing a file from a SEO-poisoned search result, leading to a Gootloader infection.   ...   <br>Around nine hours after the initial infection, the Gootloader malware facilitated the deployment of a Cobalt Strike beacon payload directly into the host’s registry, and then executed it in memory.   ...   <br>The threat actor deployed SystemBC to tunnel RDP access into the network, which aided in compromising domain controllers, backup servers, and other key servers.   ...   <br>Table of Contents: Case Summary Analysts Initial Access Execution Persistence Privilege Escalation Defense Evasion Credential Access Discovery Lateral Movement Collection Command and Control Timeline Diamond Model Indicators Detections   ...   <br>Additionally, LDAP network traffic directed to a domain controller was observed, indicating discovery operations targeting various groups, including Domain Users, Administrators, RDP Users, and Domain Administrators.   ...   <br>Following this setup, the threat actor executed multiple commands through remote services on a domain controller to ensure RDP access was enabled.   ...   <br>During this time, they also deployed the SystemBC PowerShell script on the server.   ...   <br>In our previous analysis of Gootloader, detailed in our report, “SEO Poisoning: A Gootloader Story,” we revisit the same initial access technique employed by threat actors.   ...   <br>For this intrusion, that was 46.28.105[.   ...   <br>This task was run on demand to execute the next stage in the Gootloader malware chain, and setup a Logon Trigger to maintain persistence on the beachhead.   ...   <br>Later in the intrusion the threat actor deployed a SystemBC PowerShell script.   ...   <br>The use of the Cobalt Strike ‘getsystem’ command was evident, with cmd being spawned from the beacon (DLLHOST) to elevate to a ‘SYSTEM’ context.   ...   <br>These keys stored the data for the Cobalt Strike beacon executed on the beachhead.   ...   <br>Execution of the payload to run the Cobalt Strike beacon can be observed by base64 encoded PowerShell commands   ...   <br>During the intrusion we observed activity related to Windows Defender tampering.   ...   <br>This command was executed remotely on the hosts using Cobalt Strike modules such as psexec_psh.   ...   <br>We observed process injection activity, with PowerShell and dllhost being utilized to load Cobalt Strike beacons into the memory on the beachhead host.   ...   <br>During the intrusion, we observed multiple named pipes utilized by the threat actor’s Cobalt Strike injected beacons via PowerShell and dllhost:   ...   <br>The command was executed from a SYSTEM account, and a conhost process was created with no attached console session [https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-wtsgetactiveconsolesessionid#return-value]   ...   <br>PowerView Cmdlets as part of PowerSploit were observed being used to discover the domain configuration.   ...   <br>Cobalt Strike beacons were deployed across several endpoints using remote service creation.   ...   <br>In this intrusion, the “reg add” command was executed remotely through WMI to attempt to permit RDP connections by changing the “DenyTSConnections” key to false (0), as shown with the network traffic capture below.   ...   <br>We can see the threat actor then copied the data from Sysmon eventID 24, which also shows the threat actor hostname as DESKTOP-GRALDC5.   ...   <br>The Cobalt Strike server used for this intrusion has been tracked in the DFIR Report threat intelligence feed before the incident occured.   ...   <br>The beachhead host using a Cobalt Strike beacon, injected into PowerShell and DLLHost processes; these served as the main ingress and egress command and control channel to 91.215.85[.   ...   <br>The threat actor used Cobalt Strike HTTP Beacons for command and control communication.   ...   <br>Cobalt Strike HTTP Beacon configuration:   ...   <br>Cobalt Strike SMB Beacon   ...   <br>Cobalt Strike SMB beacon configuration:   ...   <br>]20:4001 to the domain controller via a compromised endpoint.   ...   <br>In this case, RDP was used to tunnel to the Domain Controller via the PowerShell process, which used port 3389.   ...   <br>8537a157-5c6c-4173-9e65-943ff82c1efb : New Remote Access Configuration via netsh.exe b17dc721-6e2d-4f2c-aaf5-4cbdcdfed6f5 : Remote Password File Access via Notepad or Wordpad   ...   
</blockquote>

Тэги: 


Дата публикования: 
2024-02-26T00:39:52+00:00

---

# Mail in the Middle – A tool to automate spear phishing campaigns

Авторы: 


Ссылка на контент: 
https://sensepost.com/blog/2024/mail-in-the-middle-a-tool-to-automate-spear-phishing-campaigns/

Краткое содержание: 

<blockquote>
I developed a tool that we named Mail-in-the-Middle (Maitm for short).   ...   <br>If we positioned ourselves in between the sender of an email (be it a person or a system) and the legitimate recipient, we may be able to capture plenty of information about the business, including personally identifiable information, email verification processes, etc.   ...   <br>Register a good number of typos of the target’s domain Configure the DNS with the MX record pointing to an attacker-controlled mail server Configure a catch-all email address to read all these “Stranded Emails”.   ...   <br>As I’ve mentioned before, registering domains that are typo’s of the target’s domain (mostly domains that you would type if you fat-fingered an email address) is key.   ...   <br>For example, if the target was mydomain.com, you would register domains like mydoain.com,  mydomian.com or mdyomian.com.   ...   <br>Once we have registered a good number of these domains, we set the MX DNS records of all these domains to point to our mailbox.   ...   <br>This is a good sign, the catch-all rule is working.   ...   <br>Depending on the configuration you have set, the flow should be similar to the following:   ...   <br>Filter emails you want (defined in filter.yml) Inject a tracking URL (if defined in injections.yml) Inject a UNC path as image to exfiltrate NetNTLM hashes (if defined injections.yml) Replace/Inject attached files (if defined in injections.yml) Replace legitimate links with attacker-controlled links (if defined in injections.yml) Fix typos on the destination(s) email address(es) (defined in typos.yml) Forward the email to the corrected email address (defined by the CLI argument -f).   ...   <br>The source of the email can be defined in misc.yml, e.g. security@mircosoft.com.   ...   <br>Now that you know the general flow and functionality of Maitm, you just need it to run.   ...   <br>Leave this script running in background and when a recipient receives a email (and if the user allowed remote content to be displayed in the email client) you should get a hit on your tracking pixel and will be notified like this:   ...   <br>When we think about the security implications of typo’d domains, we immediately think of phishing sent from that domain to our business, but we forget about the implications of the emails sent to that typo’d domain.   ...   <br>The emails sent to these domains often contain a trove of sensitive data, which could include Personally Identifiable Information (PII), business infrastructure information, business meeting invites, bills, etc.   ...   <br>For this attack, if an attacker defined an MX record for a similar domain, they are most likely receiving emails you were supposed to be receiving!   ...   <br>For example, registering ms.com for microsoft.com and encouraging using the shorter version for email communications and user registration in third-party provider applications.   ...   
</blockquote>

Тэги: 
['phishing', 'tool', 'typosquatting']

Дата публикования: 
2024-02-26T00:00:00

---

# Deck of Cards CTF

Авторы: 


Ссылка на контент: 
https://sensepost.com/blog/2024/deck-of-cards-ctf/

Краткое содержание: 

<blockquote>
But if we do decode it, it’s more garbage.   ...   <br>Most likely whatever this garbage is, its an encrypted string using the public key given.   ...   <br>I can then use that private key (which corresponds with the public key I shared), to decrypt the message Mike has sent me.   ...   <br>We need to provide three prime numbers, two of which will be used to create a modulus (N) and one of which will be used as an encryption exponent (e).   ...   <br>This allowed me to generate different keys each time I would want to create a set of keys while also creating weak RSA keys that was big enough to encrypt the data.   ...   <br>Next, we find the decryption exponent (d) by finding the modular inverse of the exponent given phi(N).   ...   <br>You’ll then use these numbers to generate a public key given the modulus (N) and exponent (e) and generate the private key using the decryption exponent (d) and modulus (N).   ...   <br>Therefore, should we be able to figure out how the modulus was calculated, meaning that we could retrace the steps to create the decryption exponent and then create a matching private key.   ...   <br>From there it’s as simple as recreating the decryption key and regenerating a private key to decrypt the garbage hidden in the base64 encoded string.   ...   <br>Decode the data to a encrypted bin file and try recreate private key by first identifying the prime numbers of the given modulus.   ...   
</blockquote>

Тэги: 
['ctf', 'training']

Дата публикования: 
2024-02-19T00:00:00

---

# Serial PitM

Авторы: 


Ссылка на контент: 
https://sensepost.com/blog/2024/serial-pitm/

Краткое содержание: 

<blockquote>
Sometimes you need to get in the way of a hardware device and its controller, and see what it has to say for itself.   ...   <br>In this scenario, I was trying to connect to an IoT device.   ...   <br>Unplugging the dongle from the controller PC, and plugging it into my own computer’s USB port, I could see that it enumerated as an FTDI serial device.   ...   <br>This is actually quite a valuable technique – present a device to the controller that looks sufficiently similar to what it is expecting that it will use it, but that we can see what it is doing.   ...   <br>I connected the TX of one cable to the RX of the other, and vice versa, and connected the two Ground pins together.   ...   <br>Then I could use a serial terminal program like picocom to see what the controller was sending, and try to figure out the baud rate.   ...   <br>Note that the second USB Serial cable didn’t have to be an FTDI specifically, since it was only the controller PC that cared what sort of device it was talking to.   ...   <br>I plugged the dongle into my Linux PC as well, so I could relay the data that the controller was sending to the real dongle.   ...   <br>(An echo can be useful for a cli, so the person typing can see what they have typed, but it is not useful for a machine that is not expecting it.)   ...   <br>With that running, I queried the controller program to discover the PSK for the IoT device, and was able to capture the conversation with the dongle.   ...   <br>This was done by relaying the socat connection over the Internet, because it’s possible, and also because I didn’t have the dongle with me.   ...   <br>This is an option, but I have not actually had the best of luck with USBProxy, and would have had to figure out how to decapsulate the serial data from the USB packets.   ...   <br>I thought this was quite a clever use of the pin, because the standard does not provide for power to be provided over the cable, but any compliant device connected to the port would be expected to handle 12V anyway.   ...   <br>It turns out that this is a fairly common thing, with the serial ports on an industrial motherboard I looked at recently having the option to provide 12V or 5V on this pin.   ...   <br>Keeping in mind that there are two transmit lines in operation (one in each direction), to capture the data sent between the dongle and the inverter, I would need two USB-RS232 cables in order to have two receive pins.   ...   <br>To enable me to sniff the traffic between the two devices, I connected only the RX and ground pins of each USB-RS232 cable to the two data pins (pin 2 and 3), and the ground pin of the breakout boards.   ...   <br>Note that RS232 and TTL Serial specifies Rx and Tx from the perspective of the closest device normally, so a pin on a microcontroller labelled TX would mean that the microcontroller would transmit on that pin, but the device connecting to it would receive those transmissions.   ...   <br>In this case, I had two independent serial ports, /dev/ttyUSB0 and /dev/ttyUSB1 that did not need to be connected to each other as we did in the previous scenario, because the TX lines were not connected to anything.   ...   <br>Yes, you can snoop on the data going in each direction, but you cannot change it.   ...   <br>By disconnecting the header pins between the RX and TX pins, and connecting those in crossover form to the two USB-RS232 dongles, we can end up with a full PitM.   ...   <br>They don’t strictly have to be connected that way, if all you are doing is snooping, as there is an RX pin connected to both “rails”, and you can see the traffic in either direction anyway.   ...   <br>Horizontal jumpers connect A to Rx and B to Tx, vertical jumpers connect A to Tx and B to Rx.   ...   
</blockquote>

Тэги: 
['hardware', 'mitm', 'programming', 'techniques', 'tool']

Дата публикования: 
2024-02-06T00:00:00

---

# Leaking ObjRefs to Exploit HTTP .NET Remoting

Авторы: 


Ссылка на контент: 
https://code-white.com/blog/leaking-objrefs-to-exploit-http-dotnet-remoting/

Краткое содержание: 

<blockquote>
This topic is specific to a legacy technology that is retained for backward compatibility with existing applications and is not recommended for new development.   ...   <br>And while .NET Framework 4.8 appears to be the final major release of .NET Framework 4.x (i. e., there probably won’t be a 4.9 release) in favor of its cross-platform successor .NET Core (since version 5 only called “.NET”), it still is and certainly also will still be around for several years if not even decades.   ...   <br>In such cases, the RemotingSurrogateSelector and RemotingSurrogate ensure that a ObjRef gets created and registered at the server and the ObjRef gets returned to the client instead of the object.   ...   <br>In Finding and Exploiting .NET Remoting over HTTP using Deserialisation, Soroush Dalili already noticed that it is possible to overwrite somewhat trusted values returned from HttpRequest with values from corresponding HTTP headers:   ...   <br>The HTTP verb could be changed to any arbitrary verb such as GET as long as the __RequestVerb header was set to POST.   ...   <br>BaseTransportHeaders requestHeaders = new BaseTransportHeaders();   ...   <br>We have observed or suspect that the following libraries use the LogicalCallContext to store a MarshalByRefObject (most often a ObjectHandle), that leaks an ObjRef:   ...   <br>The security updates in January 2024 changed the default behavior of parsing HTTP headers in HttpHandlerTransportSink.HandleRequest(HttpContext), and no longer allow overwriting of trusted values from HttpRequest with untrusted values from HTTP headers (AppSettings.LateHttpHeaderParsing defaults to false):   ...   <br>2023-12-14: CODE WHITE added a note to the case that Azure App Services were also found to be affected by default with step-by-step instructions on how to create a vulnerable Web App instance using the ASP.NET 4.8 runtime stack.   ...   
</blockquote>

Тэги: 


Дата публикования: 
2024-02-27T00:00:00

---

