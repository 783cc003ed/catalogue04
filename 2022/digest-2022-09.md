# Attacks on Sysmon Revisited - SysmonEnte

Авторы: 


Ссылка на контент: 
https://code-white.com/blog/2022-09-attacks-on-sysmon-revisited-sysmonente/

Краткое содержание: 

<blockquote>
Inject a hook manipulating all events (in particular ProcessAccess events on Sysmon).   ...   <br>In order to undermine the aforementioned security-setup, we aimed at attacking Sysmon to tamper with events in a manner which is difficult to detect using Sysmon itself or the Windows Event Logs.   ...   <br>However, the attack must work in such a way that corresponding ProcessAccess events on Sysmon are not observable via Sysmon or the Event Log.   ...   <br>The Id field of the EVENT_DESCRIPTOR determines the type of event and is important to apply the correct struct definition for the event data pointed to by PEVENT_DATA_DESCRIPTOR.   ...   <br>We can validate this in x64dbg by setting a breakpoint at ntdll!EtwEventWrite and applying the said struct definition for a ProcessAccess event.   ...   <br>ntdll!EtwEventWrite being responsible for forwarding events is a good place to install a hook to redirect the control flow to injected code which first manipulates the event and then forwards it:   ...   <br>//Check if it is a process access event and needs to be tampered with   ...   <br>EtwEventWriteFull(RegHandle, EventDescriptor, 0, NULL, NULL, UserDataCount, UserData);   ...   <br>However, the injection into Sysmon remains observable and the corresponding ProcessAccess event is the last event we do not control.   ...   <br>Unfortunately, it is still possible to observe the duplication of the handle by configuring Object Access Auditing using a SACL on Sysmon.   ...   <br>Open a process handle to Sysmon with a very limited access mask (A detection rule based on this would generate too many false positives) Elevate this handle using ntdll!DuplicateObject to hold the PROCESS_DUP_HANDLE right (Bypasses Sysmon’s telemetry) Use the elevated handle to duplicate the pseudo Handle of Sysmon (Bypasses SACL).   ...   <br>The events are then queued and dispatched only after we resume the threads, giving us enough time to install a hook manipulating all ProcessAccess events on Sysmon itself.   ...   <br>If you have the possibility to run as a kernel driver you can probably implement the callback for the OB_OPERATION_HANDLE_DUPLICATE to monitor for Object Access Auditing Bypasses.   ...   <br>If you have the possibility to enable Object Access Auditing, you can configure a SACL for Sysmon to monitor the duplication of handles to catch the SACL bypass used to gain a handle to Sysmon.   ...   
</blockquote>

Тэги: 


Дата публикования: 
2022-09-06T00:00:00

---

